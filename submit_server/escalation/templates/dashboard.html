{% extends 'base.html' %}

{% block header %}

<script src="{{ url_for('static', filename='percentbar.js') }}"></script>
<!-- D3.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/5.9.2/d3.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.6/d3.min.js"></script>
  
<!-- Plotly.js -->
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>


<h1>{% block title %}Dashboard{% endblock %}</h1>
{% endblock %}

{% block content %}
<a name="science">
<h2>Science</h2>

<!-- Plotly success by amine bar chart -->
<a name="science.success_by_amine"></a>
<div id="success_by_amine" class="chart" style="max-width:1000px; max-height:500px;"></div>
<script type="text/javascript">
  var graph = {{success_by_amine | safe}};
  Plotly.newPlot("success_by_amine",graph.data,graph.layout, {responsive: true});        
</script>

<!-- Datatables amine overview -->
<a name="science.sci_table"></a>
<div class="sci_table" style="max-width:600px">
  <table id="sci_table" class="compact hover order-column row-border" style="width:100%">
    <thead>
      <th>Amine</th>
      <th>Success</th>      
      <th>Total</th>
      <th>Success Rate</th>      
    </thead>
    <tbody>
      {% for r in sci_table %}
      <tr>
        <td> {{ r['amine'] }} </td>
        <td> {{ r['success'] }} </td>
        <td> {{ r['total'] }} </td>
        <td> {{ r['ratio'] }} </td>                    
      </tr>
      {% endfor %}
    </tbody>
  </table>
  
  <script>
    $(document).ready(function() {
    $('#sci_table').DataTable( {
    order: [[ 3, "desc" ]],
    columnDefs: [ {      render: $.fn.dataTable.render.percentBar(), targets: [3] } ],}
    );
    }
    );
  </script>
</div>

<a name="auto"></a>
<h2>Automation</h2>

<div id="runs_by_crank" class="chart" style="max-width:1000px; max-height:500px;"></div>
<script type="text/javascript">
  var graph = {{runs_by_crank | safe}};
  Plotly.newPlot("runs_by_crank",graph.data,graph.layout, {responsive: true});        
</script>

<div id="runs_by_month" class="chart" style="max-width:1000px; max-height:500px;"></div>
<script type="text/javascript">
  var graph = {{runs_by_month | safe}};
  Plotly.newPlot("runs_by_month",graph.data,graph.layout, {responsive: true});

  var myPlot = document.getElementById('runs_by_month')

  myPlot.on('plotly_hover', function(data){
    var pn='',
        tn='';
  for(var i=0; i < data.points.length; i++){
      pn = data.points[i].pointNumber;
      tn = data.points[i].curveNumber;
    };
  var update = {'marker':{'color': '#a55942','line':{'color':'#000000','width':1}}};
  Plotly.restyle(myPlot, update, [tn]);
 })

 .on('plotly_unhover', function(data){
   tn=data.points[0].yaxis._traceIndices
   var update = {'marker':{'color': '#5eabdb','line':{'color':'#000000','width':1}}};
   Plotly.restyle(myPlot, update, tn);
});                    

  
</script>

<!-- Datatables uploads per crank -->
  <div id="uploads_by_crank" class="chart" style="max-width:1000px; max-height:400px;"></div>
  <script type="text/javascript">
    var graph = {{uploads_by_crank | safe}};
    Plotly.newPlot("uploads_by_crank",graph.data,graph.layout, {responsive: true});        
  </script>

<!-- Datatables uploads per crank -->  
<div class="auto_table">
  <table id="auto_table" class="compact hover order-column row-border" style="width:100%">
    <thead>
      <th>Crank</th>
      <th>Upload Date</th>
      <th>Number of Runs</th>
      <th>Number of Submissions</th>
    </thead>
    <tbody>
      {% for r in auto_table %}
      <tr>
        <td> {{ r['crank'] }} </td>
        <td> {{ r['upload_date'] }} </td>
        <td> {{ r['num_runs'] }} </td>                    
        <td> {{ r['num_uploads'] }} </td>                    
      </tr>
      {% endfor %}
    </tbody>
  </table>
  
  <script>
    $(document).ready(function() {
    $('#auto_table').DataTable( {
    "order": [[ 0, "desc" ]],
    }
    );
    } );
  </script>
</div>
<a name="ml"></a>
<h2>Machine Learning</h2>

<!-- Datatables uploads per crank -->
  <div id="results_by_model" class="chart" style="max-width:1000px; max-height:400px;"></div>
  <script type="text/javascript">
    var graph = {{results_by_model | safe}};
    Plotly.newPlot("results_by_model",graph.data,graph.layout, {responsive: true});        
  </script>
  
<h3>Leaderboard summary</h3>

<a href="{{ url_for('leaderboard.leaderboard') }}">View full leaderboard</a>
<table id="leaderboard_table" class="compact hover order-column row-border" style="width:100%">
  <thead>
    <th>Dataset</th>      
    <th>Name</th>      
    <th>Author</th>
    <th>Accuracy</th>
    <th>AUC</th>
    <th>F1 score</th>
    <th>Precision</th>
    <th>Recall</th>      
  </thead>
  <tbody>
    {% for r in leaderboard %}
    <tr>
      <td> {{ r['dataset_name'] }} </td>      
      <td> {{ r['model_name'] }} </td>      
      <td> {{ r['model_author'] }} </td>
      <td> {{ r['auc_score'] }} </td>
      <td> {{ r['f1_score'] }} </td>
      <td> {{ r['precision'] }} </td>
      <td> {{ r['recall'] }} </td>      

    </tr>
    {% endfor %}
  </tbody>
</table>

<script>
  $(document).ready(function() {
  $('#leaderboard_table').DataTable( {
  "order": [[ 0, "desc" ]],
  }
  );
  } );
</script>


<h3>Training Data Statistics</h3>
<div class="ml_table">
  <table id="ml_table" class="compact hover order-column row-border" style="width:100%">
    <thead>
      <th>Crank</th>
      <th>Upload Date</th>
      <th>Training Samples</th>        
      <th>Training Mean</th>
      <th>Predicted Mean</th>        
    </thead>
    <tbody>
      {% for r in ml_table %}
      <tr>
          <td> {{ r['crank'] }} </td>
          <td> {{ r['upload_date'] }} </td>
          <td> {{ r['num_train_rows'] }} </td>                    
          <td> {{ r['train_mean'] }} </td>
          <td> {{ r['pred_mean'] }} </td>                              
        </tr>
        {% endfor %}
      </tbody>
    </table>
<script>
$(document).ready(function() {
$('#ml_table').DataTable( {
        "order": [[ 0, "desc" ]],
  }
  );
  } );

</script>


<form method="post">
  <input type="submit" value="Refresh" name="update">
</form>

  
{% endblock %}
