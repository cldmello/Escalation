{% extends 'base.html' %}

{% block header %}

    <script src="{{ url_for('static', filename='percentbar.js') }}"></script>
    <!-- D3.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/5.9.2/d3.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.6/d3.min.js"></script>

    <!-- Plotly.js -->
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>

    <h1>{% block title %}Science Dashboard{% endblock title %}</h1>

{% endblock header %}

{% block content %}

    <div>
        <div class="dashboard">
            <a name="science.success_by_amine"></a>
            <div id="success_by_amine" class="chart" style="max-width:1000px; max-height:500px;"></div>
            <script type="text/javascript">
              var graph = {{success_by_amine | safe}};
              Plotly.newPlot("success_by_amine",graph.data,graph.layout, {responsive: true});
            </script>
        </div>


        <!-- Datatables amine overview -->
        <a name="science.sci_table"></a>
        <h3>Success Rate by Amine</h3>
        <div class="dashboard" id="sci_table_div">
            <table id="sci_table" class="compact hover order-column row-border" style="width:100%">
                <thead>
                <th>Amine</th>
                <th>Success</th>
                <th>Total</th>
                <th>Success Rate</th>
                </thead>
                <tbody>
                {% for r in sci_table %}
                <tr>
                    <td> {{ r['amine'] }} </td>
                    <td> {{ r['success'] }} </td>
                    <td> {{ r['total'] }} </td>
                    <td> {{ r['ratio'] }} </td>
                </tr>
                {% endfor %}
                </tbody>
            </table>

            <script>
              $(document).ready(function() {
              $('#sci_table').DataTable( {
              order: [[ 3, "desc" ]],
              columnDefs: [ {      render: $.fn.dataTable.render.percentBar(), targets: [3] } ],}
              );
              }
              );
            </script>
        </div> <!-- end amine overview -->

        <a name="science.features"></a>
        <div id="sci_features">
            <h3>Predictive Features</h3>

            <p><b>SHAP:</b></p>
            <p>SHapley Additive exPlanations is a model-agnostic direct influence technique that measures the additive contribution of a feature and value to the modelâ€™s outcome.  More info links: <A HREF="https://github.com/slundberg/shap">Code</A>, <A HREF="http://papers.nips.cc/paper/7062-a-unified-approach-to-interpreting-model-predictions">Paper</A></p>
            <div id="feature_importance_shap" class="chart"></div>
            <script type="text/javascript">
              var graph = {{feature_importance | safe}};
              Plotly.newPlot("feature_importance_shap", graph['shap'].data, graph['shap'].layout, {responsive: true});
            </script>

            <p><b>BBA:</b></p>
            <p>Black Box Auditing is a model-agnostic indirect influence technique that measures the drop in accuracy when the model is re-run on a modified version of the test data where a specific feature and all pair-wise correlations with other features are removed. More info links: <A HREF="https://github.com/algofairness/BlackBoxAuditing">Code</A>, <A HREF="https://arxiv.org/abs/1602.07043">Paper</A></p>
            <div id="feature_importance_bba" class="chart"></div>
            <script type="text/javascript">
              var graph = {{feature_importance | safe}};
              Plotly.newPlot("feature_importance_bba", graph['bba'].data, graph['bba'].layout, {responsive: true});
            </script>
        </div> <!-- end science features -->

        <a name="science.scatter_plot"></a>
        <div id="3d_rxn_scatter">
            <h3>Crystal Score and Experiments in Reaction Space</h3>
            <p>Each sphere is sized by the number of experiments run in a region of reaction space. The color represents the average crystal score for all chemicals in that region. Varying the resolution will group the experiments into larger or smaller spheres. You can also filter by a particular chemical.</p>

            <form method="post" action="{{ url_for('dashboard.dashboard_science') }}#science.scatter_plot">
                <p>Select Chemical <select name="inchikey" onchange="this.form.submit()"> </p>
                <option value="all" {% if curr_inchikey == "all" %} selected="selected" {% endif %}>All</option>
                {% for chem in chemicals %}
                <option value="{{ chem.inchi }}" {% if curr_inchikey == chem.inchi %} selected="selected"> {% endif %}>{{ chem.common_name }}</option>
                {% endfor %}
                </select>
                <noscript><input type="submit" value="Filter on Chemical"></noscript>
            </form>

            <div id="rxn_3d_scatter" class="chart" style="max-width:1000px;"></div>
            <script type="text/javascript">
          var graph = {{rxn_3d_scatter | safe}};
          Plotly.newPlot("rxn_3d_scatter",graph.data,graph.layout, {responsive: true});
        </script>
        </div> <!-- end 3d rxn scatter -->

        <!-- Datatables Reproducible clusters -->
        <a name="science.repro_table"></a>
            <h3>Experimental Reproducibility</h3>
            <p>We first cluster experiments into groups that fall within the same window of organic, inorganic, acid and temperature values (which you can change by varying the <b>Cluster Width</b> below). For each cluster, we then compute the mean crystal score and reproducibility of cluster. Reproducibility is defined as the number of experiment crystal scores that agree with the most common crystal score in that bin (so bins of size 1 have 100% reproducibility by definition).</p>
            <form method="post" action="{{ url_for('dashboard.dashboard_science') }}#science.repro_table">
                <p>Select Chemical
                    <select name="inchikey_repro">
                        <option value="all" {% if exp_repro_stats['inchi'] == "all" %} selected="selected" {% endif %}>All</option>
                        {% for chem in chemicals %}
                        <option value="{{ chem.inchi }}" {% if exp_repro_stats['inchi'] == chem.inchi %} selected="selected" {% endif %}>{{chem.common_name}}</option>
                        {% endfor %}
                    </select> &nbsp;
                    Select Cluster Width <select name="prec_repro">
                        <option value="0.1"  {% if exp_repro_stats['prec'] == 0.1  %} selected="selected" {% endif %}>0.1</option>
                        <option value="0.25" {% if exp_repro_stats['prec'] == 0.25 %} selected="selected" {% endif %}>0.25</option>
                        <option value="0.5"  {% if exp_repro_stats['prec'] == 0.5  %} selected="selected" {% endif %}>0.5</option>
                        <option value="1"    {% if exp_repro_stats['prec'] == 1    %} selected="selected" {% endif %}>1</option>
                    </select>  &nbsp;
                    <input type="submit" value="Update Table" name="reproducibility_update">
                </p>
            </form>
            <p> {{exp_repro_stats['size']}} clusters computed with bin width {{exp_repro_stats['prec']}} over {{exp_repro_stats['expts']}} experiments. The mean crystal score is {{exp_repro_stats['score']}} and the mean purity within each cluster is {{exp_repro_stats['purity']}}.</p>

            <div class="dashboard" id="sci_reproducibility_table_wrapper">
                <table id="reproducibility_table" class="compact hover order-column row-border" style="width:100%">
                    <thead>
                    <th>Inorganic Rxn</th>
                    <th>Organic Rxn</th>
                    <th>Acid Rxn</th>
                    <th>Temperature</th>
                    <th>Num. of Expts.</th>
                    <th>Avg. Crystal Score</th>
                    <th>Reproducibility</th>
                    </thead>
                    <tbody>
                    {% for r in reproducibility_table %}
                    <tr>
                        <td> {{ r['inorganic'] }} </td>
                        <td> {{ r['organic'] }} </td>
                        <td> {{ r['acid'] }} </td>
                        <td> {{ r['temp'] }} </td>
                        <td> {{ r['size'] }} </td>
                        <td> {{ r['score'] }} </td>
                        <td> {{ r['repro'] }} </td>
                    </tr>
                    {% endfor %}
                    </tbody>
                </table>

                <script>
                    $(document).ready(function() {
                    $('#reproducibility_table').DataTable( {
                    order: [[ 6, "desc" ]],
                    columnDefs: [ {      render: $.fn.dataTable.render.percentBar(), targets: [6] },
                                  {       render: $.fn.dataTable.render.scoreBar(), targets: [5] },
                     ],
                    }
                    );
                    } );
                </script>
        </div> <!-- end reproducibility table wrapper -->
    </div>  <!-- end science section -->
    <form method="post">
        <input type="submit" value="Refresh" name="update">
    </form>
{% endblock content %}
