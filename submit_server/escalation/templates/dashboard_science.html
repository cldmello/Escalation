{% extends 'base.html' %}

{% block header %}

<script src="{{ url_for('static', filename='percentbar.js') }}"></script>
<!-- D3.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/5.9.2/d3.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.6/d3.min.js"></script>

<!-- Plotly.js -->
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>


<script type=text/javascript> $SCRIPT_ROOT={{ request.script_root|tojson|safe }}; </script> <h1><a href="{{ url_for('dashboard.dashboard') }}">{% block title %}Dashboard{% endblock title %}</a></h1>

{% endblock header %}

{% block content %}

<!--Dashboard navigation-->
<ul class="navlist">
    <li class="active"><a href="{{ url_for('dashboard.dashboard_science') }}">Science</a></li>
    <li><a href="{{ url_for('dashboard.dashboard_automation') }}">Automation</a></li>
    <li><a href="{{ url_for('dashboard.dashboard_ml') }}">ML</a></li>
</ul>

<div>
    <div class="dashboard">
        <a name="science.success_by_amine"></a>
        <div id="success_by_amine" class="chart" style="max-width:1000px; max-height:500px;"></div>
        <script type="text/javascript">
            var graph = {{ success_by_amine | safe}};
            Plotly.newPlot("success_by_amine", graph.data, graph.layout, { responsive: true });
        </script>
</div>


<!-- Datatables amine overview -->
<a name="science.sci_table"></a>
<h3>Success Rate by Amine</h3>
<div class="dashboard" id="sci_table_div">
    <table id="sci_table" class="compact hover order-column row-border" style="width:100%">
        <thead>
            <th>Amine</th>
            <th>Success</th>
            <th>Total</th>
            <th>Success Rate</th>
        </thead>
        <tbody>
            {% for r in sci_table %}
            <tr>
                <td> {{ r['amine'] }} </td>
                <td> {{ r['success'] }} </td>
                <td> {{ r['total'] }} </td>
                <td> {{ r['ratio'] }} </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <script>
        $(document).ready(function () {
            $('#sci_table').DataTable({
                order: [[3, "desc"]],
                columnDefs: [{ render: $.fn.dataTable.render.percentBar(), targets: [3] }],
            }
            );
        }
        );
    </script>
</div> <!-- end amine overview -->

<a name="science.features"></a>
<div id="sci_features">
    <h3>Predictive Features</h3>

    <p><b>SHAP:</b></p>
    <p>SHapley Additive exPlanations is a model-agnostic direct influence technique that measures the additive
        contribution of a feature and value to the modelâ€™s outcome. More info links: <A
            HREF="https://github.com/slundberg/shap">Code</A>, <A
            HREF="http://papers.nips.cc/paper/7062-a-unified-approach-to-interpreting-model-predictions">Paper</A>
    </p>
    <div id="feature_importance_shap" class="chart"></div>
    <script type="text/javascript">
        var graph = {{ feature_importance | safe}};
        Plotly.newPlot("feature_importance_shap", graph['shap'].data, graph['shap'].layout, { responsive: true });
    </script>

    <p><b>BBA:</b></p>
    <p>Black Box Auditing is a model-agnostic indirect influence technique that measures the drop in accuracy when
        the model is re-run on a modified version of the test data where a specific feature and all pair-wise
        correlations with other features are removed. More info links: <A
            HREF="https://github.com/algofairness/BlackBoxAuditing">Code</A>, <A
            HREF="https://arxiv.org/abs/1602.07043">Paper</A></p>
    <div id="feature_importance_bba" class="chart"></div>
    <script type="text/javascript">
        var graph = {{ feature_importance | safe}};
        Plotly.newPlot("feature_importance_bba", graph['bba'].data, graph['bba'].layout, { responsive: true });
    </script>
</div> <!-- end science features -->

<a name="science.scatter_plot"></a>
<div id="3d_rxn_scatter">
    <h3>Crystal Score and Experiments in Reaction Space</h3>
    <p>Each point represents an experiment performed. The color represents the crystal score given to that
        particular experiment. The plot can be filtered by amine and by their scores</p>
    <form method="post" action="{{ url_for('dashboard.dashboard_science') }}#science.scatter_plot">
        <p>Select Chemical <select name="inchikey" onchange="this.form.submit()"> </p>
        <option value="all" {% if curr_inchikey == "all" %} selected="selected" {% endif %}>All</option>
        {% for chem in chemicals %}
        <option value="{{ chem.inchi }}" {% if curr_inchikey == chem.inchi %} selected="selected">
            {% endif %}>{{ chem.common_name }}</option>
        {% endfor %}
        </select>
        <noscript><input type="submit" value="Filter on Chemical"></noscript>
    </form>

    <div id="rxn_3d_scatter" class="chart" style="max-width:1000px;"></div>

    <script type="text/javascript">
        var graph = {{ rxn_3d_scatter | safe}};
        Plotly.newPlot("rxn_3d_scatter", graph.data, graph.layout, { responsive: true });
    </script>
</div> <!-- end 3d rxn scatter -->
<div id="rxn_3d_table"></div>
<script>
    var plot3d = document.getElementById("rxn_3d_scatter");
    plot3d.on('plotly_click', function (clicked_point) {
        curveNumber = clicked_point['points'][0]['curveNumber']
        pointNumber = clicked_point['points'][0]['pointNumber']
        $.post("{{ url_for('dashboard.dashboard_science') }}", { curve: curveNumber, point: pointNumber }).done(function (data) {
            console.log(data);
            document.getElementById("rxn_3d_table").innerHTML =
                `<table style="width:100%">
                <tr>
                    <td>Experiment ID</td>
                    <td>` + data[0] + `
                </tr>
                <tr>
                    <td>Inorganic Conc</td>
                    <td>` + data[3] + `
                </tr>
                <tr>
                    <td>Organic Conc</td>
                    <td>` + data[4] + `
                </tr>
                <tr>
                    <td>Acid Conc</td>
                    <td>` + data[5] + `
                </tr>
                <tr>
                    <td>Score</td>
                    <td>` + data[2] + `
                </tr>
                </table> `
        });
    })</script>
</div> <!-- end science section -->
<form method="post">
    <input type="submit" value="Refresh" name="update">
</form>
{% endblock content %}